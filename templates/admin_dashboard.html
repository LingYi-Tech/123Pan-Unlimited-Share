<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 123云盘分享</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            padding-top: 56px; /* 为 fixed-top navbar 预留空间, navbar 默认高度约 56px */
        }
        .table-responsive {
            margin-top: 1rem;
        }
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.85rem;
            word-break: break-all; /* 允许长字符串（如完整哈希）换行 */
        }
        .table td .form-control-sm {
            font-size: 0.85rem; /* 确保编辑框字体大小一致 */
        }
        /* 调整短分享码列的宽度，如果需要的话 */
        .codehash-cell {
            min-width: 250px; /* 根据实际哈希长度调整 */
        }
        .action-buttons .btn {
            margin-right: 0.25rem;
            margin-bottom: 0.25rem; /* 使得按钮在换行时有间距 */
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .share-code-cell {
            max-width: 200px; /* 长分享码仍然可以省略显示 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer; /* 暗示可点击查看完整 */
        }
        .modal-body textarea {
            width: 100%;
            min-height: 150px;
            font-family: monospace;
        }
        .nav-pills .nav-link { /* 更柔和的Admin Tab样式 */
            color: var(--primary-dark-blue);
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-dark-blue);
            color: white;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 0.4em 0.6em;
        }
        .edit-input-group {
            display: flex;
            align-items: center;
        }
        .edit-input-group input {
            flex-grow: 1;
            margin-right: 5px;
        }
        .navbar-brand {
             font-weight: bold; /* 让品牌文字更突出 */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard_page') }}">管理后台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="adminNavbar">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <span class="navbar-text me-3">
                            欢迎, {{ admin_username or '管理员' }}
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-outline-light btn-sm" href="{{ url_for('admin_logout') }}">安全退出</a>
                    </li>
                     <li class="nav-item ms-2">
                        <a class="btn btn-outline-info btn-sm" href="{{ url_for('index') }}">用户首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <ul class="nav nav-pills mb-3" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-content" type="button" role="tab">已审核 (<span id="approved-count">0</span>)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-content" type="button" role="tab">待审核 (<span id="pending-count">0</span>)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="private-tab" data-bs-toggle="tab" data-bs-target="#private-content" type="button" role="tab">私密分享 (<span id="private-count">0</span>)</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <div class="tab-pane fade show active" id="approved-content" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th class="codehash-cell">短分享码 (Hash)</th>
                                <th>分享名称 (RootFolder)</th>
                                <th>长分享码 (ShareCode)</th>
                                <th>分享时间 (Timestamp)</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="approved-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="pending-content" role="tabpanel">
                <div class="table-responsive">
                     <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th class="codehash-cell">短分享码 (Hash)</th>
                                <th>分享名称 (RootFolder)</th>
                                <th>长分享码 (ShareCode)</th>
                                <th>分享时间 (Timestamp)</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="pending-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="private-content" role="tabpanel">
                <div class="table-responsive">
                     <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th class="codehash-cell">短分享码 (Hash)</th>
                                <th>分享名称 (RootFolder)</th>
                                <th>长分享码 (ShareCode)</th>
                                <th>分享时间 (Timestamp)</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="private-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewShareCodeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">查看完整长分享码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>对应短码 (Hash):</strong> <span id="modalCodeHash"></span></p>
                    <textarea id="modalShareCodeContent" rows="10" readonly class="form-control"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="copyModalShareCode">复制到剪贴板</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const adminApiBase = `/api/{{ admin_entry }}`;

        document.addEventListener('DOMContentLoaded', function () {
            loadAllShares();

            // 绑定查看长分享码的事件 (事件委托)
            document.body.addEventListener('click', function(event) {
                if (event.target.classList.contains('view-full-code')) {
                    const codeHash = event.target.dataset.codehash;
                    const shareCode = event.target.dataset.sharecode;
                    document.getElementById('modalCodeHash').textContent = codeHash; // 显示完整短码
                    document.getElementById('modalShareCodeContent').value = shareCode;
                    new bootstrap.Modal(document.getElementById('viewShareCodeModal')).show();
                }
            });
            
            document.getElementById('copyModalShareCode').addEventListener('click', function() {
                const textarea = document.getElementById('modalShareCodeContent');
                textarea.select();
                navigator.clipboard.writeText(textarea.value).then(() => { // 使用 Clipboard API
                    this.textContent = '已复制!';
                    setTimeout(() => { this.textContent = '复制到剪贴板'; }, 2000);
                }).catch(err => {
                    console.error('无法复制文本: ', err);
                    alert('复制失败，请手动复制。');
                    // 对于旧版 execCommand 的回退（如果需要）
                    // try {
                    //     document.execCommand('copy');
                    //     this.textContent = '已复制!';
                    //     setTimeout(() => { this.textContent = '复制到剪贴板'; }, 2000);
                    // } catch (e) {
                    //     alert('复制失败，请手动复制。');
                    // }
                });
            });
        });

        async function loadAllShares() {
            try {
                const response = await fetch(`${adminApiBase}/get_shares`);
                if (!response.ok) {
                    alert(`加载分享数据失败: ${response.statusText}`);
                    return;
                }
                const data = await response.json();
                if (data.success) {
                    populateTable('approved-table-body', data.approved);
                    document.getElementById('approved-count').textContent = data.approved.length;
                    populateTable('pending-table-body', data.pending);
                    document.getElementById('pending-count').textContent = data.pending.length;
                    populateTable('private-table-body', data.private);
                    document.getElementById('private-count').textContent = data.private.length;
                } else {
                    alert(`加载分享数据失败: ${data.message}`);
                }
            } catch (error) {
                console.error('加载分享数据时出错:', error);
                alert('加载分享数据时发生网络错误。');
            }
        }

        function populateTable(tbodyId, shares) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = ''; // 清空现有行
            if (shares.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">暂无记录</td></tr>`;
                return;
            }
            shares.forEach(share => {
                const row = tbody.insertRow();
                row.dataset.codeHash = share.codeHash; // 在行上存储codeHash，方便操作

                let statusBadge = '';
                if (share.visibleFlag === true) {
                    statusBadge = '<span class="badge bg-success status-badge">已审核</span>';
                } else if (share.visibleFlag === null) {
                    statusBadge = '<span class="badge bg-warning text-dark status-badge">待审核</span>';
                } else if (share.visibleFlag === false) {
                    statusBadge = '<span class="badge bg-secondary status-badge">私密</span>';
                }

                row.innerHTML = `
                    <td class="codehash-cell">${escapeHtml(share.codeHash)}</td>
                    <td class="root-folder-name-cell">${escapeHtml(share.rootFolderName)}</td>
                    <td class="share-code-cell">
                        <span class="view-full-code" data-codehash="${escapeHtml(share.codeHash)}" data-sharecode="${escapeHtml(share.shareCode)}">
                            ${escapeHtml(share.shareCode.substring(0,10))}... (点击查看)
                        </span>
                    </td>
                    <td>${new Date(share.timeStamp).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td class="action-buttons">
                        ${generateActionButtons(share.codeHash, share.visibleFlag, share.rootFolderName)}
                    </td>
                `;
            });
        }
        
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                // 如果传入的不是字符串（例如 null 或 undefined），返回一个空字符串或进行其他适当处理
                return ''; 
            }
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function generateActionButtons(codeHash, visibleFlag, currentName) {
            let buttons = '';
            // 编辑按钮总是存在
            buttons += `<button class="btn btn-outline-info btn-sm edit-name-btn" data-currentname="${escapeHtml(currentName)}">编辑名称</button>`;
            
            if (visibleFlag === null) { // 待审核
                buttons += `<button class="btn btn-success btn-sm" onclick="updateStatus('${codeHash}', 'approved')">审核通过</button>`;
                buttons += `<button class="btn btn-secondary btn-sm" onclick="updateStatus('${codeHash}', 'private')">转私密</button>`;
            } else if (visibleFlag === true) { // 已审核
                buttons += `<button class="btn btn-warning btn-sm" onclick="updateStatus('${codeHash}', 'pending')">设为待审</button>`;
                buttons += `<button class="btn btn-secondary btn-sm" onclick="updateStatus('${codeHash}', 'private')">转私密</button>`;
            } else if (visibleFlag === false) { // 私密
                buttons += `<button class="btn btn-info btn-sm" onclick="updateStatus('${codeHash}', 'pending')">设为待审</button>`;
            }
            // 删除按钮总是存在
            buttons += `<button class="btn btn-danger btn-sm" onclick="deleteShare('${codeHash}')">删除</button>`;
            return buttons;
        }

        // 事件委托处理编辑名称
        document.body.addEventListener('click', function(event) {
            const target = event.target;
            const row = target.closest('tr');
            if (!row) return;
            const codeHash = row.dataset.codeHash;

            if (target.classList.contains('edit-name-btn')) {
                const nameCell = row.querySelector('.root-folder-name-cell');
                const currentName = target.dataset.currentname;
                nameCell.innerHTML = `
                    <div class="input-group input-group-sm edit-input-group">
                        <input type="text" class="form-control form-control-sm" value="${escapeHtml(currentName)}">
                        <button class="btn btn-success btn-sm save-name-btn">确认</button>
                        <button class="btn btn-secondary btn-sm cancel-edit-btn" data-original="${escapeHtml(currentName)}">取消</button>
                    </div>`;
                target.style.display = 'none'; // 隐藏编辑按钮
            } else if (target.classList.contains('save-name-btn')) {
                const inputField = row.querySelector('.root-folder-name-cell input[type="text"]');
                const newName = inputField.value;
                updateName(codeHash, newName, row);
            } else if (target.classList.contains('cancel-edit-btn')) {
                const nameCell = row.querySelector('.root-folder-name-cell');
                const originalName = target.dataset.original;
                nameCell.textContent = originalName; // 直接恢复文本内容
                const editButton = row.querySelector('.edit-name-btn')
                if(editButton) editButton.style.display = 'inline-block'; // 显示编辑按钮
            }
        });
        
        async function updateName(codeHash, newName, rowElement) {
            if (!newName.trim()) {
                alert("分享名称不能为空。");
                return;
            }
            if (!confirm(`确定要将短码 ${escapeHtml(codeHash)} 的名称修改为 "${escapeHtml(newName)}" 吗？`)) {
                return;
            }
            try {
                const response = await fetch(`${adminApiBase}/update_share_name`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ codeHash: codeHash, newName: newName })
                });
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    const nameCell = rowElement.querySelector('.root-folder-name-cell');
                    nameCell.textContent = escapeHtml(data.cleanedName); 
                    const editButton = rowElement.querySelector('.edit-name-btn');
                    if(editButton) {
                        editButton.dataset.currentname = data.cleanedName;
                        editButton.style.display = 'inline-block'; 
                    }
                    // 局部刷新可能导致状态不同步，考虑全量刷新或者更复杂的行数据更新
                    await loadAllShares(); 
                } else {
                    alert(`修改名称失败: ${data.message}`);
                }
            } catch (error) {
                console.error('修改名称时出错:', error);
                alert('修改名称时发生网络错误。');
            }
        }

        async function updateStatus(codeHash, newStatus) {
            let statusText = "";
            if (newStatus === 'approved') statusText = "审核通过";
            else if (newStatus === 'pending') statusText = "设为待审核";
            else if (newStatus === 'private') statusText = "转为私密";

            if (!confirm(`确定要将短码 ${escapeHtml(codeHash)} 的状态改为 "${statusText}" 吗？`)) {
                return;
            }

            try {
                const response = await fetch(`${adminApiBase}/update_share_status`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ codeHash: codeHash, newStatus: newStatus })
                });
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    loadAllShares(); 
                } else {
                    alert(`更新状态失败: ${data.message}`);
                }
            } catch (error) {
                console.error('更新状态时出错:', error);
                alert('更新状态时发生网络错误。');
            }
        }

        async function deleteShare(codeHash) {
            if (!confirm(`确定要永久删除短码为 ${escapeHtml(codeHash)} 的分享记录吗？此操作不可恢复！`)) {
                return;
            }
            try {
                const response = await fetch(`${adminApiBase}/delete_share`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ codeHash: codeHash })
                });
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    loadAllShares(); 
                } else {
                    alert(`删除失败: ${data.message}`);
                }
            } catch (error) {
                console.error('删除分享时出错:', error);
                alert('删除分享时发生网络错误。');
            }
        }
    </script>
</body>
</html>